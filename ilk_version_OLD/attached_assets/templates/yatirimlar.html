<!-- templates/yatirimlar.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yatırım Yönetimi - Finansal Varlık Takip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/custom.css">
    <style>
        .card {
            margin-bottom: 20px;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .search-results {
            position: absolute;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 0 0 0.25rem 0.25rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }
        .search-results .list-group-item {
            cursor: pointer;
            padding: 0.5rem 1rem;
        }
        .search-results .list-group-item:hover {
            background-color: #f8f9fa;
        }
        .kategori-tab {
            cursor: pointer;
        }
        .kategori-tab.active {
            background-color: #0d6efd;
            color: white;
        }
        .kod-arama-wrapper {
            position: relative;
        }
        .table td {
            vertical-align: middle;
        }
        .btn-action-group {
            white-space: nowrap;
        }
        
        /* Kısaltılmış metin için stiller */
        .truncated-text {
            cursor: help;
            border-bottom: 1px dotted #999;
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
    
        /* Tablo hücrelerinin boyutlarını kontrol etme */
        .table td.fixed-width {
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    
        .table td.fixed-width-sm {
            max-width: 100px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    
        /* Tooltipleri daha güzel gösterme */
        .tooltip-inner {
            max-width: 300px;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.8);
            font-size: 14px;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Finansal Varlık Takip</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/yatirimlar">Yatırım Yönetimi</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Yeni Yatırım Ekle</h5>
                    </div>
                    <div class="card-body">
                        <form id="yatirimEkleForm">
                            <div class="mb-3">
                                <label for="tip" class="form-label">Yatırım Tipi</label>
                                <select class="form-select" id="tip" name="tip" required>
                                    <option value="">Seçiniz</option>
                                    <option value="fon">Yatırım Fonu</option>
                                    <option value="hisse">Hisse Senedi</option>
                                    <option value="altin">Altın</option>
                                    <option value="doviz">Döviz</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="kod" class="form-label">Kod</label>
                                <div class="kod-arama-wrapper">
                                    <input type="text" class="form-control" id="kod" name="kod" required autocomplete="off">
                                    <div id="kodSonuclar" class="search-results">
                                        <div class="list-group"></div>
                                    </div>
                                </div>
                                <div class="form-text" id="kodYardim"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="isim" class="form-label">İsim (İsteğe Bağlı)</label>
                                <input type="text" class="form-control" id="isim" name="isim">
                                <div class="form-text">İsim belirtmezseniz, veri güncellemesi sırasında otomatik eklenecektir.</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="alis_tarihi" class="form-label">Alış Tarihi</label>
                                <input type="date" class="form-control" id="alis_tarihi" name="alis_tarihi" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="alis_fiyati" class="form-label">Alış Fiyatı</label>
                                <input type="text" inputmode="decimal" class="form-control" id="alis_fiyati" name="alis_fiyati" step="any" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="miktar" class="form-label">Miktar</label>
                                <input type="text" inputmode="decimal" class="form-control" id="miktar" name="miktar" step="any" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="kategori" class="form-label">Kategori (İsteğe Bağlı)</label>
                                <select class="form-select" id="kategori" name="kategori">
                                    <option value="">Seçiniz</option>
                                    <option value="Emeklilik">Emeklilik</option>
                                    <option value="Acil Durum">Acil Durum</option>
                                    <option value="Uzun Vadeli">Uzun Vadeli</option>
                                    <option value="Kısa Vadeli">Kısa Vadeli</option>
                                    <option value="Spekülatif">Spekülatif</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="notlar" class="form-label">Notlar (İsteğe Bağlı)</label>
                                <textarea class="form-control" id="notlar" name="notlar" rows="3"></textarea>
                            </div>
                            
                            <div class="d-flex">
                                <button type="submit" class="btn btn-primary">Yatırım Ekle</button>
                                <button type="button" id="btnDogrula" class="btn btn-outline-secondary ms-2">Veriyi Doğrula</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Yatırımlarım</h5>
                        <div class="d-flex">
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-outline-light kategori-tab active" data-kategori="hepsi">Hepsi</button>
                                <button type="button" class="btn btn-outline-light kategori-tab" data-kategori="fon">Fonlar</button>
                                <button type="button" class="btn btn-outline-light kategori-tab" data-kategori="hisse">Hisseler</button>
                                <button type="button" class="btn btn-outline-light kategori-tab" data-kategori="doviz">Döviz</button>
                                <button type="button" class="btn btn-outline-light kategori-tab" data-kategori="altin">Altın</button>
                            </div>
                            <button id="btnTumVerileriGuncelle" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> Tüm Verileri Güncelle
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Kod</th>
                                        <th>İsim</th>
                                        <th>Tip</th>
                                        <th>Kategori</th>
                                        <th>Miktar</th>
                                        <th>Alış Fiyatı</th>
                                        <th>Güncel Fiyat</th>
                                        <th>Kâr/Zarar</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody id="yatirimlarTablosu">
                                    <!-- JavaScript ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Düzenleme Modalı -->
    <div class="modal fade" id="duzenleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yatırım Düzenle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <form id="yatirimDuzenleForm">
                        <input type="hidden" id="duzenle_id">
                        
                        <div class="mb-3">
                            <label for="duzenle_tip" class="form-label">Yatırım Tipi</label>
                            <select class="form-select" id="duzenle_tip" name="duzenle_tip" required>
                                <option value="fon">Yatırım Fonu</option>
                                <option value="hisse">Hisse Senedi</option>
                                <option value="altin">Altın</option>
                                <option value="doviz">Döviz</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="duzenle_kod" class="form-label">Kod</label>
                            <div class="kod-arama-wrapper">
                                <input type="text" class="form-control" id="duzenle_kod" name="duzenle_kod" required autocomplete="off">
                                <div id="duzenleKodSonuclar" class="search-results">
                                    <div class="list-group"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="duzenle_isim" class="form-label">İsim</label>
                            <input type="text" class="form-control" id="duzenle_isim" name="duzenle_isim">
                        </div>
                        
                        <div class="mb-3">
                            <label for="duzenle_alis_tarihi" class="form-label">Alış Tarihi</label>
                            <input type="date" class="form-control" id="duzenle_alis_tarihi" name="duzenle_alis_tarihi" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="duzenle_alis_fiyati" class="form-label">Alış Fiyatı</label>
                            <input type="text" inputmode="decimal" class="form-control" id="duzenle_alis_fiyati" name="duzenle_alis_fiyati" step="any" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="duzenle_miktar" class="form-label">Miktar</label>
                            <input type="text" inputmode="decimal" class="form-control" id="duzenle_miktar" name="duzenle_miktar" step="any" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="duzenle_kategori" class="form-label">Kategori</label>
                            <select class="form-select" id="duzenle_kategori" name="duzenle_kategori">
                                <option value="">Seçiniz</option>
                                <option value="Emeklilik">Emeklilik</option>
                                <option value="Acil Durum">Acil Durum</option>
                                <option value="Uzun Vadeli">Uzun Vadeli</option>
                                <option value="Kısa Vadeli">Kısa Vadeli</option>
                                <option value="Spekülatif">Spekülatif</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="duzenle_notlar" class="form-label">Notlar</label>
                            <textarea class="form-control" id="duzenle_notlar" name="duzenle_notlar" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="btnYatirimKaydet">Kaydet</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Silme Onay Modalı -->
    <div class="modal fade" id="silModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yatırımı Sil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <p>Bu yatırımı silmek istediğinizden emin misiniz?</p>
                    <p id="silYatirimBilgi" class="font-weight-bold"></p>
                    <p class="text-danger">Bu işlem geri alınamaz!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-danger" id="btnYatirimSil">Sil</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Doğrulama Sonucu Modalı -->
    <div class="modal fade" id="dogrulamaModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Yatırım Bilgileri</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body" id="dogrulamaSonucu">
                    <!-- Doğrulama sonuçları burada gösterilecek -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/search.js"></script>
    <script src="/static/js/actions.js"></script>
    <script src="/static/js/truncate.js"></script>
    <script>
        // Sayfa yüklendiğinde yatırımları getir
        document.addEventListener('DOMContentLoaded', function() {
            // Bugünün tarihini varsayılan olarak ayarla
            document.getElementById('alis_tarihi').valueAsDate = new Date();
            
            // Yatırım tipine göre kod yardımı
            document.getElementById('tip').addEventListener('change', function() {
                const tip = this.value;
                const kodYardimElement = document.getElementById('kodYardim');
                
                if (tip === 'fon') {
                    kodYardimElement.innerHTML = 'Örnek: TLI, TI2, AFA, TTE';
                } else if (tip === 'hisse') {
                    kodYardimElement.innerHTML = 'Örnek: THYAO, GARAN, ASELS, SISE';
                } else if (tip === 'altin') {
                    kodYardimElement.innerHTML = 'Örnek: GA (Gram Altın), C (Çeyrek), Y (Yarım), T (Tam), ONS';
                } else if (tip === 'doviz') {
                    kodYardimElement.innerHTML = 'Örnek: USD, EUR, GBP';
                } else {
                    kodYardimElement.innerHTML = '';
                }
            });
            
            // Arama işlevselliğini ekleform için başlat
            initializeSearch({
                kodInput: document.getElementById('kod'),
                kodSonuclar: document.getElementById('kodSonuclar'),
                tipSelect: document.getElementById('tip'),
                isimInput: document.getElementById('isim'),
                alisFiyatiInput: document.getElementById('alis_fiyati')
            });
            
            // Düzenleme formu için arama işlevselliğini başlat
            initializeSearch({
                kodInput: document.getElementById('duzenle_kod'),
                kodSonuclar: document.getElementById('duzenleKodSonuclar'),
                tipSelect: document.getElementById('duzenle_tip'),
                isimInput: document.getElementById('duzenle_isim'),
                alisFiyatiInput: document.getElementById('duzenle_alis_fiyati')
            });
            
            // Kategori filtresi
            document.querySelectorAll('.kategori-tab').forEach(button => {
                button.addEventListener('click', function() {
                    // Aktif sınıfını kaldır
                    document.querySelectorAll('.kategori-tab').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Tıklanan butona active sınıfını ekle
                    this.classList.add('active');
                    
                    const kategori = this.getAttribute('data-kategori');
                    if (kategori === 'hepsi') {
                        getirYatirimlar();
                    } else {
                        getirKategoriYatirimlar(kategori);
                    }
                });
            });
            
            // Tüm verileri güncelleme butonu
            document.getElementById('btnTumVerileriGuncelle').addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Güncelleniyor...';
                
                fetch('/api/yatirimlar/guncelle', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    // Sayfayı yenile
                    getirYatirimlar();
                    
                    // Butonu eski haline getir
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Tüm Verileri Güncelle';
                    
                    // Bildirim ver
                    alert('Veriler güncellendi!');
                })
                .catch(error => {
                    console.error('Güncelleme hatası:', error);
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Tüm Verileri Güncelle';
                    alert('Veri güncelleme sırasında bir hata oluştu!');
                });
            });
            
            // Doğrulama butonu
            document.getElementById('btnDogrula').addEventListener('click', function() {
                const tip = document.getElementById('tip').value;
                const kod = document.getElementById('kod').value;
                
                if (!tip || !kod) {
                    alert('Lütfen yatırım tipi ve kodunu girin!');
                    return;
                }
                
                fetch('/api/yatirim/dogrula', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tip: tip,
                        kod: kod
                    })
                })
                .then(response => response.json())
                .then(data => {
                    const dogrulamaSonucu = document.getElementById('dogrulamaSonucu');
                    const dogrulamaModal = new bootstrap.Modal(document.getElementById('dogrulamaModal'));
                    
                    if (data.basarili) {
                        const veri = data.veri;
                        dogrulamaSonucu.innerHTML = `
                            <div class="alert alert-success">
                                <h5>Yatırım bilgileri başarıyla doğrulandı!</h5>
                            </div>
                            <div class="mt-3">
                                <p><strong>Kod:</strong> ${veri.kod}</p>
                                <p><strong>İsim:</strong> ${veri.isim || '-'}</p>
                                <p><strong>Güncel Fiyat:</strong> ${formatParaBirimi(veri.guncel_fiyat)}</p>
                                <p><strong>Son Güncelleme:</strong> ${formatTarihSaat(veri.tarih)}</p>
                            </div>
                        `;
                        
                        // İsim alanı boşsa ve isim geliyorsa
                        if (!document.getElementById('isim').value && veri.isim) {
                            document.getElementById('isim').value = veri.isim;
                        }
                        
                        // Alış fiyatı alanı boşsa, güncel fiyatı doldur
                        if (!document.getElementById('alis_fiyati').value) {
                            document.getElementById('alis_fiyati').value = veri.guncel_fiyat;
                        }
                    } else {
                        dogrulamaSonucu.innerHTML = `
                            <div class="alert alert-danger">
                                <h5>Yatırım bilgileri doğrulanamadı!</h5>
                                <p>${data.hata}</p>
                            </div>
                            <div class="mt-3">
                                <p>Lütfen kod ve yatırım tipini kontrol edip tekrar deneyin.</p>
                            </div>
                        `;
                    }
                    
                    dogrulamaModal.show();
                })
                .catch(error => {
                    console.error('Doğrulama hatası:', error);
                    alert('Doğrulama sırasında bir hata oluştu!');
                });
            });
            
            // Yatırım ekleme formu
            document.getElementById('yatirimEkleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    tip: document.getElementById('tip').value,
                    kod: document.getElementById('kod').value,
                    isim: document.getElementById('isim').value,
                    alis_tarihi: document.getElementById('alis_tarihi').value,
                    alis_fiyati: document.getElementById('alis_fiyati').value.replace(',', '.'),
                    miktar: document.getElementById('miktar').value.replace(',', '.'),
                    kategori: document.getElementById('kategori').value,
                    notlar: document.getElementById('notlar').value
                };
                
                // Validasyon
                if (!formData.tip || !formData.kod || !formData.alis_tarihi || !formData.alis_fiyati || !formData.miktar) {
                    alert('Lütfen zorunlu alanları doldurun!');
                    return;
                }
                
                fetch('/api/yatirim', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.basarili) {
                        // Formu temizle
                        document.getElementById('yatirimEkleForm').reset();
                        document.getElementById('alis_tarihi').valueAsDate = new Date();
                        document.getElementById('kodYardim').innerHTML = '';
                        
                        // Yatırımları yenile
                        getirYatirimlar();
                        
                        alert('Yatırım başarıyla eklendi!');
                    } else {
                        alert('Yatırım eklenemedi: ' + data.hata);
                    }
                })
                .catch(error => {
                    console.error('Yatırım ekleme hatası:', error);
                    alert('Yatırım eklenirken bir hata oluştu!');
                });
            });
            
            // Yeni kod: Sayfa yüklendiğinde tablo truncate işlemini başlat
            const yatirimlarTablosu = document.querySelector('table');
                initTruncateTable(yatirimlarTablosu, {
                    isimMaxLength: 15,
                    kategoriMaxLength: 15
                });

            // Yatırımları getir
            getirYatirimlar();
        });

        function getirYatirimlar() {
            fetch('/api/yatirimlar')
                .then(response => response.json())
                .then(data => {
                    const yatirimlarTablosu = document.getElementById('yatirimlarTablosu');
                    yatirimlarTablosu.innerHTML = '';
                    
                    if (data.length === 0) {
                        const emptyRow = document.createElement('tr');
                        const emptyCell = document.createElement('td');
                        emptyCell.colSpan = 9;
                        emptyCell.className = 'text-center';
                        emptyCell.textContent = 'Henüz yatırım kaydı bulunmuyor.';
                        emptyRow.appendChild(emptyCell);
                        yatirimlarTablosu.appendChild(emptyRow);
                        return;
                    }
                    
                    // Yatırımları tabloya ekle
                    data.forEach(yatirim => {
                        const row = document.createElement('tr');
                        
                        // Kod
                        const kodCell = document.createElement('td');
                        kodCell.textContent = yatirim.kod;
                        row.appendChild(kodCell);
                        
                        // İsim
                        const isimCell = document.createElement('td');
                        isimCell.className = 'fixed-width';
                        if (yatirim.isim) {
                            isimCell.appendChild(truncateText(yatirim.isim, 70));
                        } else {
                            isimCell.textContent = '-';
                        }
                        row.appendChild(isimCell);
                        
                        // Tip
                        const tipCell = document.createElement('td');
                        tipCell.textContent = getTipAdi(yatirim.tip);
                        row.appendChild(tipCell);
                        
                        // Kategori
                        const kategoriCell = document.createElement('td');
                        kategoriCell.className = 'fixed-width-sm';
                        if (yatirim.kategori) {
                            kategoriCell.appendChild(truncateText(yatirim.kategori, 40));
                        } else {
                            kategoriCell.textContent = '-';
                        }
                        row.appendChild(kategoriCell);
                        
                        // Miktar
                        const miktarCell = document.createElement('td');
                        miktarCell.textContent = formatMiktar(yatirim.miktar);
                        row.appendChild(miktarCell);
                        
                        // Alış Fiyatı
                        const alisFiyatiCell = document.createElement('td');
                        alisFiyatiCell.textContent = formatParaBirimi(yatirim.alis_fiyati);
                        row.appendChild(alisFiyatiCell);
                        
                        // Güncel Fiyat
                        const guncelFiyatCell = document.createElement('td');
                        guncelFiyatCell.textContent = yatirim.guncel_fiyat ? formatParaBirimi(yatirim.guncel_fiyat) : '-';
                        row.appendChild(guncelFiyatCell);
                        
                        // Kâr/Zarar
                        const karZararCell = document.createElement('td');
                        if (yatirim.kar_zarar_tl !== null && yatirim.kar_zarar_yuzde !== null) {
                            karZararCell.textContent = `${formatParaBirimi(yatirim.kar_zarar_tl)} (${yatirim.kar_zarar_yuzde.toFixed(2)}%)`;
                            karZararCell.className = yatirim.kar_zarar_tl >= 0 ? 'positive' : 'negative';
                        } else {
                            karZararCell.textContent = '-';
                        }
                        row.appendChild(karZararCell);
                        
                        // İşlemler
                        const islemlerCell = document.createElement('td');
                        islemlerCell.className = 'btn-action-group';
                        
                        // Güncelleme butonu
                        const guncelleBtn = document.createElement('button');
                        guncelleBtn.className = 'btn btn-sm btn-success me-1';
                        guncelleBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                        guncelleBtn.setAttribute('title', 'Güncelle');
                        guncelleBtn.addEventListener('click', function() {
                            yatirimGuncelle(yatirim.id);
                        });
                        
                        // Düzenleme butonu
                        const duzenleBtn = document.createElement('button');
                        duzenleBtn.className = 'btn btn-sm btn-primary me-1';
                        duzenleBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                        duzenleBtn.setAttribute('title', 'Düzenle');
                        duzenleBtn.addEventListener('click', function() {
                            yatirimDuzenle(yatirim.id);
                        });
                        
                        // Silme butonu
                        const silBtn = document.createElement('button');
                        silBtn.className = 'btn btn-sm btn-danger';
                        silBtn.innerHTML = '<i class="bi bi-trash"></i>';
                        silBtn.setAttribute('title', 'Sil');
                        silBtn.addEventListener('click', function() {
                            yatirimSil(yatirim.id, yatirim.kod, yatirim.isim);
                        });
                        
                        islemlerCell.appendChild(guncelleBtn);
                        islemlerCell.appendChild(duzenleBtn);
                        islemlerCell.appendChild(silBtn);
                        row.appendChild(islemlerCell);
                        
                        yatirimlarTablosu.appendChild(row);
                    });
                    
                    // Tooltipleri başlat
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                })
                .catch(error => {
                    console.error('Yatırım verisi getirme hatası:', error);
                });
        }
        
        function getirKategoriYatirimlar(kategori) {
            fetch(`/api/yatirimlar/${kategori}`)
                .then(response => response.json())
                .then(data => {
                    const yatirimlarTablosu = document.getElementById('yatirimlarTablosu');
                    yatirimlarTablosu.innerHTML = '';
                    
                    if (data.length === 0) {
                        const emptyRow = document.createElement('tr');
                        const emptyCell = document.createElement('td');
                        emptyCell.colSpan = 9;
                        emptyCell.className = 'text-center';
                        emptyCell.textContent = `Bu kategoride yatırım kaydı bulunmuyor.`;
                        emptyRow.appendChild(emptyCell);
                        yatirimlarTablosu.appendChild(emptyRow);
                        return;
                    }
                    
                    // Yatırımları tabloya ekle
                    data.forEach(yatirim => {
                        const row = document.createElement('tr');
                        
                        // Kod
                        const kodCell = document.createElement('td');
                        kodCell.textContent = yatirim.kod;
                        row.appendChild(kodCell);
                        
                        // İsim
                        const isimCell = document.createElement('td');
                        isimCell.className = 'fixed-width';
                        if (yatirim.isim) {
                            isimCell.appendChild(truncateText(yatirim.isim, 70));
                        } else {
                            isimCell.textContent = '-';
                        }
                        row.appendChild(isimCell);
                        
                        // Tip
                        const tipCell = document.createElement('td');
                        tipCell.textContent = getTipAdi(yatirim.tip);
                        row.appendChild(tipCell);
                        
                        // Kategori
                        const kategoriCell = document.createElement('td');
                        kategoriCell.className = 'fixed-width-sm';
                        if (yatirim.kategori) {
                            kategoriCell.appendChild(truncateText(yatirim.kategori, 40));
                        } else {
                            kategoriCell.textContent = '-';
                        }
                        row.appendChild(kategoriCell);
                        
                        // Miktar
                        const miktarCell = document.createElement('td');
                        miktarCell.textContent = formatMiktar(yatirim.miktar);
                        row.appendChild(miktarCell);
                        
                        // Alış Fiyatı
                        const alisFiyatiCell = document.createElement('td');
                        alisFiyatiCell.textContent = formatParaBirimi(yatirim.alis_fiyati);
                        row.appendChild(alisFiyatiCell);
                        
                        // Güncel Fiyat
                        const guncelFiyatCell = document.createElement('td');
                        guncelFiyatCell.textContent = yatirim.guncel_fiyat ? formatParaBirimi(yatirim.guncel_fiyat) : '-';
                        row.appendChild(guncelFiyatCell);
                        
                        // Kâr/Zarar
                        const karZararCell = document.createElement('td');
                        if (yatirim.kar_zarar_tl !== null && yatirim.kar_zarar_yuzde !== null) {
                            karZararCell.textContent = `${formatParaBirimi(yatirim.kar_zarar_tl)} (${yatirim.kar_zarar_yuzde.toFixed(2)}%)`;
                            karZararCell.className = yatirim.kar_zarar_tl >= 0 ? 'positive' : 'negative';
                        } else {
                            karZararCell.textContent = '-';
                        }
                        row.appendChild(karZararCell);
                        
                        // İşlemler
                        const islemlerCell = document.createElement('td');
                        islemlerCell.className = 'btn-action-group';
                        
                        // Güncelleme butonu
                        const guncelleBtn = document.createElement('button');
                        guncelleBtn.className = 'btn btn-sm btn-success me-1';
                        guncelleBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                        guncelleBtn.setAttribute('title', 'Güncelle');
                        guncelleBtn.addEventListener('click', function() {
                            yatirimGuncelle(yatirim.id);
                        });
                        
                        // Düzenleme butonu
                        const duzenleBtn = document.createElement('button');
                        duzenleBtn.className = 'btn btn-sm btn-primary me-1';
                        duzenleBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                        duzenleBtn.setAttribute('title', 'Düzenle');
                        duzenleBtn.addEventListener('click', function() {
                            yatirimDuzenle(yatirim.id);
                        });
                        
                        // Silme butonu
                        const silBtn = document.createElement('button');
                        silBtn.className = 'btn btn-sm btn-danger';
                        silBtn.innerHTML = '<i class="bi bi-trash"></i>';
                        silBtn.setAttribute('title', 'Sil');
                        silBtn.addEventListener('click', function() {
                            yatirimSil(yatirim.id, yatirim.kod, yatirim.isim);
                        });
                        
                        islemlerCell.appendChild(guncelleBtn);
                        islemlerCell.appendChild(duzenleBtn);
                        islemlerCell.appendChild(silBtn);
                        row.appendChild(islemlerCell);
                        
                        yatirimlarTablosu.appendChild(row);
                    });
                    
                    // Tooltipleri başlat
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                })
                .catch(error => {
                    console.error('Yatırım verisi getirme hatası:', error);
                });
        }

        function yatirimGuncelle(id) {
            const guncelleButton = event.currentTarget;
            const originalHTML = guncelleButton.innerHTML;
            
            guncelleButton.disabled = true;
            guncelleButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            
            fetch(`/api/yatirim/${id}/guncelle`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.basarili) {
                    // Yatırımları yenile
                    getirYatirimlar();
                    alert('Yatırım verisi güncellendi!');
                } else {
                    alert('Yatırım verisi güncellenemedi: ' + data.hata);
                }
                
                guncelleButton.disabled = false;
                guncelleButton.innerHTML = originalHTML;
            })
            .catch(error => {
                console.error('Yatırım güncelleme hatası:', error);
                alert('Yatırım güncellenirken bir hata oluştu!');
                
                guncelleButton.disabled = false;
                guncelleButton.innerHTML = originalHTML;
            });
        }

        function yatirimDuzenle(id) {
            fetch(`/api/yatirim/${id}`)
                .then(response => response.json())
                .then(data => {
                    // Düzenleme modalını aç
                    const duzenleModal = new bootstrap.Modal(document.getElementById('duzenleModal'));
                    
                    // Form alanlarını doldur
                    document.getElementById('duzenle_id').value = data.id;
                    document.getElementById('duzenle_tip').value = data.tip;
                    document.getElementById('duzenle_kod').value = data.kod;
                    document.getElementById('duzenle_isim').value = data.isim || '';
                    document.getElementById('duzenle_alis_tarihi').value = data.alis_tarihi;
                    document.getElementById('duzenle_alis_fiyati').value = data.alis_fiyati;
                    document.getElementById('duzenle_miktar').value = data.miktar;
                    document.getElementById('duzenle_kategori').value = data.kategori || '';
                    document.getElementById('duzenle_notlar').value = data.notlar || '';
                    
                    // Kaydet butonuna click event handler ekle
                    document.getElementById('btnYatirimKaydet').onclick = function() {
                        // Form verilerini al
                        const formData = {
                            tip: document.getElementById('duzenle_tip').value,
                            kod: document.getElementById('duzenle_kod').value,
                            isim: document.getElementById('duzenle_isim').value,
                            alis_tarihi: document.getElementById('duzenle_alis_tarihi').value,
                            alis_fiyati: document.getElementById('duzenle_alis_fiyati').value.replace(',', '.'),
                            miktar: document.getElementById('duzenle_miktar').value.replace(',', '.'),
                            kategori: document.getElementById('duzenle_kategori').value,
                            notlar: document.getElementById('duzenle_notlar').value
                        };
                        
                        // Validasyon
                        if (!formData.tip || !formData.kod || !formData.alis_tarihi || !formData.alis_fiyati || !formData.miktar) {
                            alert('Lütfen zorunlu alanları doldurun!');
                            return;
                        }
                        
                        // Güncelleme isteği gönder
                        fetch(`/api/yatirim/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.basarili) {
                                // Modalı kapat
                                duzenleModal.hide();
                                
                                // Yatırımları yenile
                                getirYatirimlar();
                                
                                alert('Yatırım başarıyla güncellendi!');
                            } else {
                                alert('Yatırım güncellenemedi: ' + data.hata);
                            }
                        })
                        .catch(error => {
                            console.error('Yatırım güncelleme hatası:', error);
                            alert('Yatırım güncellenirken bir hata oluştu!');
                        });
                    };
                    
                    duzenleModal.show();
                })
                .catch(error => {
                    console.error('Yatırım detayı getirme hatası:', error);
                    alert('Yatırım detayı getirilemedi!');
                });
        }

        function yatirimSil(id, kod, isim) {
            // Silme modalını aç
            const silModal = new bootstrap.Modal(document.getElementById('silModal'));
            
            // Yatırım bilgilerini göster
            document.getElementById('silYatirimBilgi').textContent = `${kod} (${isim || 'İsimsiz'})`;
            
            // Sil butonuna click event handler ekle
            document.getElementById('btnYatirimSil').onclick = function() {
                fetch(`/api/yatirim/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.basarili) {
                        // Modalı kapat
                        silModal.hide();
                        
                        // Yatırımları yenile
                        getirYatirimlar();
                        
                        alert('Yatırım başarıyla silindi!');
                    } else {
                        alert('Yatırım silinemedi: ' + data.hata);
                    }
                })
                .catch(error => {
                    console.error('Yatırım silme hatası:', error);
                    alert('Yatırım silinirken bir hata oluştu!');
                });
            };
            
            silModal.show();
        }

        // Yardımcı fonksiyonlar
        function formatParaBirimi(deger) {
            if (deger === null || deger === undefined) return '-';
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(deger);
        }
        
        function formatMiktar(miktar) {
            if (miktar === null || miktar === undefined) return '-';
            return new Intl.NumberFormat('tr-TR', { 
                minimumFractionDigits: 0,
                maximumFractionDigits: 6
            }).format(miktar);
        }
        
        function formatTarih(tarih) {
            if (!tarih) return '-';
            const d = new Date(tarih);
            return new Intl.DateTimeFormat('tr-TR').format(d);
        }
        
        function formatTarihSaat(tarih) {
            if (!tarih) return '-';
            const d = new Date(tarih);
            return new Intl.DateTimeFormat('tr-TR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(d);
        }
        
        function getTipAdi(tip) {
            const tipler = {
                'fon': 'Yatırım Fonu',
                'hisse': 'Hisse Senedi',
                'altin': 'Altın',
                'doviz': 'Döviz'
            };
            
            return tipler[tip] || tip;
        }
    </script>
</body>
</html>