<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finansal Varlık Takip</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/custom.css">
    <style>
        .card {
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .chart-container {
            height: 300px;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
        }
        .nav-pills .nav-link {
            color: #0d6efd;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Finansal Varlık Takip</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="/">Ana Sayfa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/yatirimlar">Yatırım Yönetimi</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <button id="btnVeriGuncelle" class="btn btn-outline-light">
                            <i class="bi bi-arrow-clockwise"></i> Verileri Güncelle
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Toplam Varlık Özeti</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>Toplam Güncel Değer:</div>
                            <div class="fs-4 fw-bold" id="toplamDeger">0.00 ₺</div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>Toplam Maliyet:</div>
                            <div class="fs-5" id="toplamMaliyet">0.00 ₺</div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>Toplam Kâr/Zarar:</div>
                            <div class="fs-5" id="toplamKarZarar">0.00 ₺ (0.00%)</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">30 Günlük Performans</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>Değişim (₺):</div>
                            <div class="fs-5" id="otuzGunTL">0.00 ₺</div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>Değişim (%):</div>
                            <div class="fs-5" id="otuzGunYuzde">0.00%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Varlık Dağılımı</h5>
                    </div>
                    <div class="card-body">
                        <div id="dagilimGrafik" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="card-title mb-0">Varlık Tiplerine Göre Özet</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Varlık Tipi</th>
                                        <th>Güncel Değer</th>
                                        <th>Maliyet</th>
                                        <th>Kâr/Zarar (₺)</th>
                                        <th>Kâr/Zarar (%)</th>
                                    </tr>
                                </thead>
                                <tbody id="tipOzetTablosu">
                                    <!-- JavaScript ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning">
                        <h5 class="card-title mb-0">Performans Sıralaması</h5>
                    </div>
                    <div class="card-body">
                        <div id="performansGrafik" class="chart-container"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3 mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Tüm Yatırımlar</h5>
                        <div>
                            <ul class="nav nav-pills">
                                <li class="nav-item">
                                    <a class="nav-link active" data-kategori="hepsi">Hepsi</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-kategori="fon">Fonlar</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-kategori="hisse">Hisseler</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-kategori="doviz">Döviz</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-kategori="altin">Altın</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead>
                                    <tr>
                                        <th>Kod</th>
                                        <th>İsim</th>
                                        <th>Tip</th>
                                        <th>Kategori</th>
                                        <th>Alış Fiyatı</th>
                                        <th>Güncel Fiyat</th>
                                        <th>Miktar</th>
                                        <th>Güncel Değer</th>
                                        <th>Kâr/Zarar</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="tumYatirimlarTablosu">
                                    <!-- JavaScript ile doldurulacak -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detay Modalı -->
    <div class="modal fade" id="yatirimDetayModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="yatirimDetayBaslik">Yatırım Detayı</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <div id="yatirimBilgileri">
                        <!-- Bilgiler JavaScript ile doldurulacak -->
                    </div>
                    <div class="mt-4">
                        <h5>Fiyat Geçmişi (Son 30 Gün)</h5>
                        <div id="fiyatGecmisiGrafik" style="height: 300px;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist@2.24.2/plotly.min.js"></script>
    <script>
        // Sayfa yüklendiğinde verileri getir
        document.addEventListener('DOMContentLoaded', function() {
            getirOzetVerileri();
            getirTumYatirimlar();
            getirDagilimGrafigi();
            getirPerformansGrafigi();
            
            // Kategori filtresi
            document.querySelectorAll('.nav-link[data-kategori]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Aktif sınıfını kaldır
                    document.querySelectorAll('.nav-link[data-kategori]').forEach(item => {
                        item.classList.remove('active');
                    });
                    // Tıklanan link'e active sınıfı ekle
                    this.classList.add('active');
                    
                    const kategori = this.getAttribute('data-kategori');
                    if (kategori === 'hepsi') {
                        getirTumYatirimlar();
                    } else {
                        getirKategoriYatirimlar(kategori);
                    }
                });
            });
        });

        // Veri güncelleme butonu
        document.getElementById('btnVeriGuncelle').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Güncelleniyor...';
            
            fetch('/api/yatirimlar/guncelle', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                // Sayfayı yenile
                getirOzetVerileri();
                getirTumYatirimlar();
                getirDagilimGrafigi();
                getirPerformansGrafigi();
                
                // Butonu eski haline getir
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Verileri Güncelle';
                
                // Bildirim ver
                alert('Veriler güncellendi!');
            })
            .catch(error => {
                console.error('Güncelleme hatası:', error);
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Verileri Güncelle';
                alert('Veri güncelleme sırasında bir hata oluştu!');
            });
        });

        function getirOzetVerileri() {
            fetch('/api/ozet')
                .then(response => response.json())
                .then(data => {
                    // Toplam özet verilerini doldur
                    document.getElementById('toplamDeger').textContent = formatParaBirimi(data.toplam_deger);
                    document.getElementById('toplamMaliyet').textContent = formatParaBirimi(data.toplam_maliyet);
                    
                    const karZararElement = document.getElementById('toplamKarZarar');
                    const karZararDeger = data.toplam_kar_zarar;
                    const karZararYuzde = data.toplam_kar_zarar_yuzde;
                    
                    karZararElement.textContent = `${formatParaBirimi(karZararDeger)} (${karZararYuzde.toFixed(2)}%)`;
                    karZararElement.className = karZararDeger >= 0 ? 'fs-5 positive' : 'fs-5 negative';
                    
                    // 30 günlük verileri doldur
                    const otuzGunTLElement = document.getElementById('otuzGunTL');
                    const otuzGunYuzdeElement = document.getElementById('otuzGunYuzde');
                    
                    otuzGunTLElement.textContent = formatParaBirimi(data.otuz_gun.degisim_tl);
                    otuzGunTLElement.className = data.otuz_gun.degisim_tl >= 0 ? 'fs-5 positive' : 'fs-5 negative';
                    
                    otuzGunYuzdeElement.textContent = `${data.otuz_gun.degisim_yuzde.toFixed(2)}%`;
                    otuzGunYuzdeElement.className = data.otuz_gun.degisim_yuzde >= 0 ? 'fs-5 positive' : 'fs-5 negative';
                    
                    // Tip özetlerini doldur
                    const tipOzetTablosu = document.getElementById('tipOzetTablosu');
                    tipOzetTablosu.innerHTML = '';
                    
                    // Türkçe tip isimleri
                    const tipIsimleri = {
                        'fon': 'Yatırım Fonu',
                        'hisse': 'Hisse Senedi',
                        'altin': 'Altın',
                        'doviz': 'Döviz'
                    };
                    
                    for (const [tip, isim] of Object.entries(tipIsimleri)) {
                        if (data.tip_ozetleri[tip]) {
                            const ozet = data.tip_ozetleri[tip];
                            
                            const row = document.createElement('tr');
                            
                            // İsim hücresi
                            const isimCell = document.createElement('td');
                            isimCell.textContent = isim;
                            row.appendChild(isimCell);
                            
                            // Güncel değer hücresi
                            const degerCell = document.createElement('td');
                            degerCell.textContent = formatParaBirimi(ozet.guncel_deger);
                            row.appendChild(degerCell);
                            
                            // Maliyet hücresi
                            const maliyetCell = document.createElement('td');
                            maliyetCell.textContent = formatParaBirimi(ozet.maliyet);
                            row.appendChild(maliyetCell);
                            
                            // Kâr/zarar (TL) hücresi
                            const karZararTLCell = document.createElement('td');
                            karZararTLCell.textContent = formatParaBirimi(ozet.kar_zarar_tl);
                            karZararTLCell.className = ozet.kar_zarar_tl >= 0 ? 'positive' : 'negative';
                            row.appendChild(karZararTLCell);
                            
                            // Kâr/zarar (%) hücresi
                            const karZararYuzdeCell = document.createElement('td');
                            karZararYuzdeCell.textContent = `${ozet.kar_zarar_yuzde.toFixed(2)}%`;
                            karZararYuzdeCell.className = ozet.kar_zarar_yuzde >= 0 ? 'positive' : 'negative';
                            row.appendChild(karZararYuzdeCell);
                            
                            tipOzetTablosu.appendChild(row);
                        }
                    }
                })
                .catch(error => {
                    console.error('Özet veri getirme hatası:', error);
                });
        }

        function getirTumYatirimlar() {
            fetch('/api/yatirimlar')
                .then(response => response.json())
                .then(data => {
                    const tumYatirimlarTablosu = document.getElementById('tumYatirimlarTablosu');
                    tumYatirimlarTablosu.innerHTML = '';
                    
                    if (data.length === 0) {
                        const emptyRow = document.createElement('tr');
                        const emptyCell = document.createElement('td');
                        emptyCell.colSpan = 10;
                        emptyCell.className = 'text-center';
                        emptyCell.textContent = 'Henüz yatırım kaydı bulunmuyor.';
                        emptyRow.appendChild(emptyCell);
                        tumYatirimlarTablosu.appendChild(emptyRow);
                        return;
                    }
                    
                    // Yatırımları tabloya ekle
                    data.forEach(yatirim => {
                        const row = document.createElement('tr');
                        
                        // Kod
                        const kodCell = document.createElement('td');
                        kodCell.textContent = yatirim.kod;
                        row.appendChild(kodCell);
                        
                        // İsim
                        const isimCell = document.createElement('td');
                        isimCell.textContent = yatirim.isim || '-';
                        row.appendChild(isimCell);
                        
                        // Tip
                        const tipCell = document.createElement('td');
                        tipCell.textContent = getTipAdi(yatirim.tip);
                        row.appendChild(tipCell);
                        
                        // Kategori
                        const kategoriCell = document.createElement('td');
                        kategoriCell.textContent = yatirim.kategori || '-';
                        row.appendChild(kategoriCell);
                        
                        // Alış Fiyatı
                        const alisFiyatiCell = document.createElement('td');
                        alisFiyatiCell.textContent = formatParaBirimi(yatirim.alis_fiyati);
                        row.appendChild(alisFiyatiCell);
                        
                        // Güncel Fiyat
                        const guncelFiyatCell = document.createElement('td');
                        guncelFiyatCell.textContent = yatirim.guncel_fiyat ? formatParaBirimi(yatirim.guncel_fiyat) : '-';
                        row.appendChild(guncelFiyatCell);
                        
                        // Miktar
                        const miktarCell = document.createElement('td');
                        miktarCell.textContent = formatMiktar(yatirim.miktar);
                        row.appendChild(miktarCell);
                        
                        // Güncel Değer
                        const guncelDegerCell = document.createElement('td');
                        guncelDegerCell.textContent = yatirim.guncel_tutar ? formatParaBirimi(yatirim.guncel_tutar) : '-';
                        row.appendChild(guncelDegerCell);
                        
                        // Kâr/Zarar
                        const karZararCell = document.createElement('td');
                        if (yatirim.kar_zarar_tl !== null && yatirim.kar_zarar_yuzde !== null) {
                            karZararCell.textContent = `${formatParaBirimi(yatirim.kar_zarar_tl)} (${yatirim.kar_zarar_yuzde.toFixed(2)}%)`;
                            karZararCell.className = yatirim.kar_zarar_tl >= 0 ? 'positive' : 'negative';
                        } else {
                            karZararCell.textContent = '-';
                        }
                        row.appendChild(karZararCell);
                        
                        // İşlemler
                        const islemlerCell = document.createElement('td');
                        const detayBtn = document.createElement('button');
                        detayBtn.className = 'btn btn-sm btn-info me-1';
                        detayBtn.innerHTML = '<i class="bi bi-info-circle"></i>';
                        detayBtn.setAttribute('title', 'Detay');
                        detayBtn.addEventListener('click', function() {
                            yatirimDetayGoster(yatirim.id);
                        });
                        
                        islemlerCell.appendChild(detayBtn);
                        row.appendChild(islemlerCell);
                        
                        tumYatirimlarTablosu.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Yatırım verisi getirme hatası:', error);
                });
        }
        
        function getirKategoriYatirimlar(kategori) {
            fetch(`/api/yatirimlar/${kategori}`)
                .then(response => response.json())
                .then(data => {
                    const tumYatirimlarTablosu = document.getElementById('tumYatirimlarTablosu');
                    tumYatirimlarTablosu.innerHTML = '';
                    
                    if (data.length === 0) {
                        const emptyRow = document.createElement('tr');
                        const emptyCell = document.createElement('td');
                        emptyCell.colSpan = 10;
                        emptyCell.className = 'text-center';
                        emptyCell.textContent = `Bu kategoride yatırım kaydı bulunmuyor.`;
                        emptyRow.appendChild(emptyCell);
                        tumYatirimlarTablosu.appendChild(emptyRow);
                        return;
                    }
                    
                    // Yatırımları tabloya ekle
                    data.forEach(yatirim => {
                        const row = document.createElement('tr');
                        
                        // Kod
                        const kodCell = document.createElement('td');
                        kodCell.textContent = yatirim.kod;
                        row.appendChild(kodCell);
                        
                        // İsim
                        const isimCell = document.createElement('td');
                        isimCell.textContent = yatirim.isim || '-';
                        row.appendChild(isimCell);
                        
                        // Tip
                        const tipCell = document.createElement('td');
                        tipCell.textContent = getTipAdi(yatirim.tip);
                        row.appendChild(tipCell);
                        
                        // Kategori
                        const kategoriCell = document.createElement('td');
                        kategoriCell.textContent = yatirim.kategori || '-';
                        row.appendChild(kategoriCell);
                        
                        // Alış Fiyatı
                        const alisFiyatiCell = document.createElement('td');
                        alisFiyatiCell.textContent = formatParaBirimi(yatirim.alis_fiyati);
                        row.appendChild(alisFiyatiCell);
                        
                        // Güncel Fiyat
                        const guncelFiyatCell = document.createElement('td');
                        guncelFiyatCell.textContent = yatirim.guncel_fiyat ? formatParaBirimi(yatirim.guncel_fiyat) : '-';
                        row.appendChild(guncelFiyatCell);
                        
                        // Miktar
                        const miktarCell = document.createElement('td');
                        miktarCell.textContent = formatMiktar(yatirim.miktar);
                        row.appendChild(miktarCell);
                        
                        // Güncel Değer
                        const guncelDegerCell = document.createElement('td');
                        guncelDegerCell.textContent = yatirim.guncel_tutar ? formatParaBirimi(yatirim.guncel_tutar) : '-';
                        row.appendChild(guncelDegerCell);
                        
                        // Kâr/Zarar
                        const karZararCell = document.createElement('td');
                        if (yatirim.kar_zarar_tl !== null && yatirim.kar_zarar_yuzde !== null) {
                            karZararCell.textContent = `${formatParaBirimi(yatirim.kar_zarar_tl)} (${yatirim.kar_zarar_yuzde.toFixed(2)}%)`;
                            karZararCell.className = yatirim.kar_zarar_tl >= 0 ? 'positive' : 'negative';
                        } else {
                            karZararCell.textContent = '-';
                        }
                        row.appendChild(karZararCell);
                        
                        // İşlemler
                        const islemlerCell = document.createElement('td');
                        const detayBtn = document.createElement('button');
                        detayBtn.className = 'btn btn-sm btn-info me-1';
                        detayBtn.innerHTML = '<i class="bi bi-info-circle"></i>';
                        detayBtn.setAttribute('title', 'Detay');
                        detayBtn.addEventListener('click', function() {
                            yatirimDetayGoster(yatirim.id);
                        });
                        
                        islemlerCell.appendChild(detayBtn);
                        row.appendChild(islemlerCell);
                        
                        tumYatirimlarTablosu.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Yatırım verisi getirme hatası:', error);
                });
        }

        function getirDagilimGrafigi() {
            fetch('/api/grafik/dagilim')
                .then(response => response.json())
                .then(data => {
                    const dagilimGrafik = document.getElementById('dagilimGrafik');
                    
                    if (!data.labels || !data.values || data.labels.length === 0) {
                        dagilimGrafik.innerHTML = '<div class="alert alert-info text-center">Grafik için yeterli veri bulunmuyor.</div>';
                        return;
                    }
                    
                    const tipIsimleri = {
                        'fon': 'Yatırım Fonu',
                        'hisse': 'Hisse Senedi',
                        'altin': 'Altın',
                        'doviz': 'Döviz'
                    };
                    
                    // Etiketleri Türkçe'ye çevir
                    const labels = data.labels.map(label => tipIsimleri[label] || label);
                    
                    const layout = {
                        autosize: true,
                        margin: {l: 10, r: 10, t: 10, b: 10},
                        showlegend: true,
                        legend: {
                            orientation: "v",
                            x: 1,
                            y: 0.5
                        },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: {
                            color: '#ddd'
                        }
                    };
                    
                    const config = {
                        responsive: true,
                        displayModeBar: false
                    };
                    
                    const plotData = [{
                        values: data.values,
                        labels: labels,
                        type: 'pie',
                        textinfo: 'percent',
                        hoverinfo: 'label+percent+value',
                        hovertemplate: '%{label}<br>%{percent}<br>%{value:.2f} ₺<extra></extra>',
                        marker: {
                            colors: ['#6610f2', '#fd7e14', '#ffc107', '#20c997']
                        }
                    }];
                    
                    Plotly.newPlot(dagilimGrafik, plotData, layout, config);
                })
                .catch(error => {
                    console.error('Dağılım grafiği oluşturma hatası:', error);
                    const dagilimGrafik = document.getElementById('dagilimGrafik');
                    dagilimGrafik.innerHTML = '<div class="alert alert-danger text-center">Grafik yüklenirken bir hata oluştu.</div>';
                });
        }
        
        function getirPerformansGrafigi() {
            fetch('/api/grafik/performans')
                .then(response => response.json())
                .then(data => {
                    const performansGrafik = document.getElementById('performansGrafik');
                    
                    if (!data.yatirimlar || data.yatirimlar.length === 0) {
                        performansGrafik.innerHTML = '<div class="alert alert-info text-center">Grafik için yeterli veri bulunmuyor.</div>';
                        return;
                    }
                    
                    // Verileri performansa göre sırala (en yüksekten en düşüğe)
                    data.yatirimlar.sort((a, b) => b.yuzde - a.yuzde);
                    
                    const kodlar = data.yatirimlar.map(y => y.kod);
                    const yuzdelik = data.yatirimlar.map(y => y.yuzde);
                    const tlDegisimleri = data.yatirimlar.map(y => y.tl);
                    
                    // Pozitif ve negatif değerler için farklı renkler
                    const barRenkler = yuzdelik.map(value => value >= 0 ? '#28a745' : '#dc3545');
                    
                    const layout = {
                        autosize: true,
                        margin: {l: 10, r: 10, t: 10, b: 80},
                        barmode: 'group',
                        xaxis: {
                            tickangle: -45,
                            title: {
                                text: 'Yatırımlar',
                                standoff: 20
                            }
                        },
                        yaxis: {
                            title: {
                                text: 'Kâr/Zarar (%)',
                                standoff: 20
                            },
                            ticksuffix: '%'
                        },
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: {
                            color: '#ddd'
                        }
                    };
                    
                    const config = {
                        responsive: true,
                        displayModeBar: false
                    };
                    
                    const plotData = [{
                        x: kodlar,
                        y: yuzdelik,
                        text: yuzdelik.map(value => `${value.toFixed(2)}%`),
                        textposition: 'auto',
                        hovertemplate: 'Kod: %{x}<br>Değişim: %{y:.2f}%<br>TL: %{customdata} ₺<extra></extra>',
                        customdata: tlDegisimleri.map(tl => tl.toFixed(2)),
                        type: 'bar',
                        marker: {
                            color: barRenkler
                        }
                    }];
                    
                    Plotly.newPlot(performansGrafik, plotData, layout, config);
                })
                .catch(error => {
                    console.error('Performans grafiği oluşturma hatası:', error);
                    const performansGrafik = document.getElementById('performansGrafik');
                    performansGrafik.innerHTML = '<div class="alert alert-danger text-center">Grafik yüklenirken bir hata oluştu.</div>';
                });
        }

        function yatirimDetayGoster(id) {
            fetch(`/api/yatirim/${id}`)
                .then(response => response.json())
                .then(data => {
                    const modal = new bootstrap.Modal(document.getElementById('yatirimDetayModal'));
                    const baslik = document.getElementById('yatirimDetayBaslik');
                    const bilgiler = document.getElementById('yatirimBilgileri');
                    
                    // Başlık ayarla
                    baslik.textContent = `${data.isim ? data.isim : data.kod} - Detay`;
                    
                    // Bilgileri doldur
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Kod:</strong> ${data.kod}</p>
                                <p><strong>İsim:</strong> ${data.isim || '-'}</p>
                                <p><strong>Tip:</strong> ${getTipAdi(data.tip)}</p>
                                <p><strong>Kategori:</strong> ${data.kategori || '-'}</p>
                                <p><strong>Alış Tarihi:</strong> ${formatTarih(data.alis_tarihi)}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Alış Fiyatı:</strong> ${formatParaBirimi(data.alis_fiyati)}</p>
                                <p><strong>Güncel Fiyat:</strong> ${data.guncel_fiyat ? formatParaBirimi(data.guncel_fiyat) : '-'}</p>
                                <p><strong>Miktar:</strong> ${formatMiktar(data.miktar)}</p>
                                <p><strong>Değişim:</strong> <span class="${data.kar_zarar_tl >= 0 ? 'positive' : 'negative'}">${data.kar_zarar_tl ? formatParaBirimi(data.kar_zarar_tl) : '-'} (${data.kar_zarar_yuzde ? data.kar_zarar_yuzde.toFixed(2) + '%' : '-'})</span></p>
                                <p><strong>Son Güncelleme:</strong> ${data.son_guncelleme ? formatTarihSaat(data.son_guncelleme) : '-'}</p>
                            </div>
                        </div>
                    `;
                    
                    if (data.notlar) {
                        html += `
                            <div class="mt-3">
                                <h6>Notlar:</h6>
                                <div class="p-2 border rounded">
                                    <p class="mb-0">${data.notlar}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    bilgiler.innerHTML = html;
                    
                    // Fiyat geçmişi grafiğini oluştur
                    fetch(`/api/yatirim/${id}/fiyat-gecmisi`)
                        .then(response => response.json())
                        .then(gecmis => {
                            if (!gecmis || gecmis.length === 0) {
                                document.getElementById('fiyatGecmisiGrafik').innerHTML = '<div class="alert alert-info text-center">Fiyat geçmişi verisi bulunmuyor.</div>';
                                return;
                            }
                            
                            const tarihler = gecmis.map(g => g.tarih);
                            const fiyatlar = gecmis.map(g => g.fiyat);
                            
                            const layout = {
                                autosize: true,
                                margin: {l: 50, r: 20, t: 20, b: 50},
                                xaxis: {
                                    title: 'Tarih'
                                },
                                yaxis: {
                                    title: 'Fiyat (₺)'
                                },
                                paper_bgcolor: 'rgba(0,0,0,0)',
                                plot_bgcolor: 'rgba(0,0,0,0)',
                                font: {
                                    color: '#ddd'
                                }
                            };
                            
                            const config = {
                                responsive: true,
                                displayModeBar: false
                            };
                            
                            const plotData = [{
                                x: tarihler,
                                y: fiyatlar,
                                mode: 'lines+markers',
                                type: 'scatter',
                                line: {
                                    color: '#0d6efd',
                                    width: 2
                                },
                                marker: {
                                    color: '#0d6efd',
                                    size: 6
                                },
                                hovertemplate: '%{x}<br>%{y:.6f} ₺<extra></extra>'
                            }];
                            
                            Plotly.newPlot('fiyatGecmisiGrafik', plotData, layout, config);
                        })
                        .catch(error => {
                            console.error('Fiyat geçmişi getirme hatası:', error);
                            document.getElementById('fiyatGecmisiGrafik').innerHTML = '<div class="alert alert-danger text-center">Fiyat geçmişi yüklenirken bir hata oluştu.</div>';
                        });
                    
                    // Modalı göster
                    modal.show();
                })
                .catch(error => {
                    console.error('Yatırım detayı getirme hatası:', error);
                    alert('Yatırım detayı getirilirken bir hata oluştu!');
                });
        }

        // Yardımcı fonksiyonlar
        function formatParaBirimi(deger) {
            if (deger === null || deger === undefined) return '-';
            return new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(deger);
        }
        
        function formatMiktar(miktar) {
            if (miktar === null || miktar === undefined) return '-';
            return new Intl.NumberFormat('tr-TR', { 
                minimumFractionDigits: 0,
                maximumFractionDigits: 6
            }).format(miktar);
        }
        
        function formatTarih(tarih) {
            if (!tarih) return '-';
            const d = new Date(tarih);
            return new Intl.DateTimeFormat('tr-TR').format(d);
        }
        
        function formatTarihSaat(tarih) {
            if (!tarih) return '-';
            const d = new Date(tarih);
            return new Intl.DateTimeFormat('tr-TR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).format(d);
        }
        
        function getTipAdi(tip) {
            const tipler = {
                'fon': 'Yatırım Fonu',
                'hisse': 'Hisse Senedi',
                'altin': 'Altın',
                'doviz': 'Döviz'
            };
            
            return tipler[tip] || tip;
        }
    </script>
</body>
</html>