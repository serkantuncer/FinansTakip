{% extends "base.html" %}

{% block title %}Yatırımlar - Yatırım Takip{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>
                    <i class="fas fa-chart-line me-2"></i>
                    Yatırımlarım
                </h1>
                <div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#yatirimEkleModal">
                        <i class="fas fa-plus me-2"></i>Yeni Yatırım
                    </button>
                    <form method="POST" action="{{ url_for('toplu_fiyat_guncelle') }}" class="d-inline">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-sync me-2"></i>Fiyatları Güncelle
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Arama</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search }}" placeholder="Kod, isim veya nota göre ara...">
                        </div>
                        <div class="col-md-3">
                            <label for="tip" class="form-label">Tip</label>
                            <select class="form-select" id="tip" name="tip">
                                <option value="">Tümü</option>
                                <option value="fon" {% if tip_filter == 'fon' %}selected{% endif %}>Fon</option>
                                <option value="hisse" {% if tip_filter == 'hisse' %}selected{% endif %}>Hisse</option>
                                <option value="altin" {% if tip_filter == 'altin' %}selected{% endif %}>Altın</option>
                                <option value="doviz" {% if tip_filter == 'doviz' %}selected{% endif %}>Döviz</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="kategori" class="form-label">Kategori</label>
                            <select class="form-select" id="kategori" name="kategori">
                                <option value="">Tümü</option>
                                {% for kategori in kategoriler %}
                                <option value="{{ kategori }}" {% if kategori_filter == kategori %}selected{% endif %}>
                                    {{ kategori }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Filtrele
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Investments Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    {% if yatirimlar %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tip</th>
                                    <th>Kod</th>
                                    <th>İsim</th>
                                    <th>Alış Tarihi</th>
                                    <th>Alış Fiyatı</th>
                                    <th>Miktar</th>
                                    <th>Alış Tutarı</th>
                                    <th>Güncel Fiyat</th>
                                    <th>Güncel Tutar</th>
                                    <th>Kar/Zarar</th>
                                    <th>Getiri %</th>
                                    <th>Kategori</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for yatirim in yatirimlar %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">{{ yatirim.tip|title }}</span>
                                    </td>
                                    <td><strong>{{ yatirim.kod }}</strong></td>
                                    <td>
                                        <span class="text-truncate" data-bs-toggle="tooltip" title="{{ yatirim.isim or 'İsim yok' }}">
                                            {{ yatirim.isim[:30] + '...' if yatirim.isim and yatirim.isim|length > 30 else yatirim.isim or '-' }}
                                        </span>
                                    </td>
                                    <td>{{ yatirim.alis_tarihi.strftime('%d.%m.%Y') }}</td>
                                    <td>₺{{ "{:,.2f}".format(yatirim.alis_fiyati) }}</td>
                                    <td>{{ "{:,.2f}".format(yatirim.miktar) }}</td>
                                    <td>₺{{ "{:,.2f}".format(yatirim.alis_fiyati * yatirim.miktar) }}</td>
                                    <td>
                                        {% if yatirim.guncel_fiyat %}
                                            ₺{{ "{:,.2f}".format(yatirim.guncel_fiyat) }}
                                            {% if yatirim.son_guncelleme %}
                                                <br><small class="text-muted">{{ yatirim.son_guncelleme.strftime('%d.%m %H:%M') }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if yatirim.guncel_fiyat %}
                                            ₺{{ "{:,.2f}".format(yatirim.guncel_fiyat * yatirim.miktar) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if yatirim.guncel_fiyat %}
                                            {% set kar_zarar = (yatirim.guncel_fiyat - yatirim.alis_fiyati) * yatirim.miktar %}
                                            <span class="{% if kar_zarar >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                ₺{{ "{:+,.2f}".format(kar_zarar) }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if yatirim.guncel_fiyat %}
                                            {% set getiri = (yatirim.guncel_fiyat / yatirim.alis_fiyati - 1) * 100 %}
                                            <span class="{% if getiri >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ "{:+.2f}".format(getiri) }}%
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if yatirim.kategori %}
                                            <span class="badge bg-info">{{ yatirim.kategori }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <form method="POST" action="{{ url_for('fiyat_guncelle_route', yatirim_id=yatirim.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-outline-success" data-bs-toggle="tooltip" title="Fiyat Güncelle">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </form>
                                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" 
                                                    data-bs-target="#duzenleModal{{ yatirim.id }}" title="Düzenle">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" 
                                                    data-bs-target="#silModal{{ yatirim.id }}" title="Sil">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted">Henüz yatırım eklenmemiş</h4>
                        <p class="text-muted mb-4">İlk yatırımınızı ekleyerek başlayın!</p>
                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#yatirimEkleModal">
                            <i class="fas fa-plus me-2"></i>İlk Yatırımı Ekle
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Investment Modal -->
<div class="modal fade" id="yatirimEkleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Yeni Yatırım Ekle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('yatirim_ekle') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tip" class="form-label">Yatırım Tipi *</label>
                            <select class="form-select" id="tip" name="tip" required onchange="updateCodePlaceholder()">
                                <option value="">Seçiniz</option>
                                <option value="fon">Yatırım Fonu</option>
                                <option value="hisse">Hisse Senedi</option>
                                <option value="altin">Altın</option>
                                <option value="doviz">Döviz</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="kod" class="form-label">Kod *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="kod" name="kod" required
                                       placeholder="Yatırım tipi seçin..." 
                                       oninput="searchCodes(this.value)" 
                                       onblur="validateCode()"
                                       autocomplete="off">
                                <button type="button" class="btn btn-outline-secondary" id="validateBtn" 
                                        onclick="validateCode()" style="display: none;">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="kodOrnekleri" class="form-text" style="display: none;"></div>
                            <div id="searchResults" class="list-group position-absolute" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto; width: 100%;"></div>
                            <div id="kodSonuc" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="alis_tarihi" class="form-label">Alış Tarihi *</label>
                            <input type="date" class="form-control" id="alis_tarihi" name="alis_tarihi" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="alis_fiyati" class="form-label">Alış Fiyatı (₺) *</label>
                            <input type="number" class="form-control" id="alis_fiyati" name="alis_fiyati" 
                                   step="0.000001" min="0" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="miktar" class="form-label">Miktar *</label>
                            <input type="number" class="form-control" id="miktar" name="miktar" 
                                   step="0.000001" min="0.000001" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="kategori" class="form-label">Kategori</label>
                            <select class="form-select" id="kategori" name="kategori">
                                <option value="">Kategori Seçin</option>
                                <option value="Emeklilik">Emeklilik</option>
                                <option value="Acil Durum">Acil Durum</option>
                                <option value="Uzun Vadeli">Uzun Vadeli</option>
                                <option value="Kısa Vadeli">Kısa Vadeli</option>
                                <option value="Spekülatif">Spekülatif</option>
                                <option value="Güvenli Liman">Güvenli Liman</option>
                                <option value="Diğer">Diğer</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notlar" class="form-label">Notlar</label>
                        <textarea class="form-control" id="notlar" name="notlar" rows="3"
                                  placeholder="İsteğe bağlı notlarınız..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modals -->
{% for yatirim in yatirimlar %}
<div class="modal fade" id="duzenleModal{{ yatirim.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Yatırım Düzenle: {{ yatirim.kod }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('yatirim_duzenle', yatirim_id=yatirim.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Alış Fiyatı (₺)</label>
                        <input type="number" class="form-control" name="alis_fiyati" 
                               step="0.000001" value="{{ yatirim.alis_fiyati }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Miktar</label>
                        <input type="number" class="form-control" name="miktar" 
                               step="0.000001" value="{{ yatirim.miktar }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kategori</label>
                        <input type="text" class="form-control" name="kategori" value="{{ yatirim.kategori or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notlar</label>
                        <textarea class="form-control" name="notlar" rows="3">{{ yatirim.notlar or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Güncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="silModal{{ yatirim.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Yatırım Sil
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>{{ yatirim.kod }}</strong> kodlu yatırımı silmek istediğinizden emin misiniz?</p>
                <p class="text-muted small">Bu işlem geri alınamaz ve tüm fiyat geçmişi de silinecektir.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <form method="POST" action="{{ url_for('yatirim_sil', yatirim_id=yatirim.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Sil
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default date to today
    document.getElementById('alis_tarihi').value = new Date().toISOString().split('T')[0];
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Predefined investment codes for search
const investmentCodes = {
    'fon': [
        { kod: 'ZBJ', isim: 'ZİRAAT PORTFÖY BAŞAK PARA PİYASASI (TL) FONU' },
        { kod: 'APK', isim: 'AKBANK PORTFÖY HİSSE SENEDİ FONU' },
        { kod: 'AEF', isim: 'AKBANK PORTFÖY EUROBOND (TL) FONU' },
        { kod: 'AFT', isim: 'AKBANK PORTFÖY FLEKSİBEL FON SERİSİ 2' },
        { kod: 'AHF', isim: 'AKBANK PORTFÖY HİSSE SENEDİ FONU' },
        { kod: 'TEB', isim: 'TEB PORTFÖY HİSSE SENEDİ FONU' },
        { kod: 'YAS', isim: 'YAPI KREDİ PORTFÖY A TİPİ SERBEST FON' }
    ],
    'hisse': [
        { kod: 'THYAO', isim: 'TÜRK HAVA YOLLARI A.O.' },
        { kod: 'GARAN', isim: 'GARANTİ BANKASI A.Ş.' },
        { kod: 'ASELS', isim: 'ASELSAN ELEKTRONİK SANAYİ VE TİCARET A.Ş.' },
        { kod: 'SISE', isim: 'ŞİŞE VE CAM FABRİKALARI A.Ş.' },
        { kod: 'BIMAS', isim: 'BİM BİRLEŞİK MAĞAZALAR A.Ş.' },
        { kod: 'AKBNK', isim: 'AKBANK T.A.Ş.' },
        { kod: 'ISCTR', isim: 'İŞ BANKASI (C) A.Ş.' }
    ],
    'altin': [
        { kod: 'GA', isim: 'Gram Altın' },
        { kod: 'C', isim: 'Çeyrek Altın' },
        { kod: 'Y', isim: 'Yarım Altın' },
        { kod: 'T', isim: 'Tam Altın' },
        { kod: 'ONS', isim: 'Ons Altın' }
    ],
    'doviz': [
        { kod: 'USD', isim: 'Amerikan Doları' },
        { kod: 'EUR', isim: 'Euro' },
        { kod: 'GBP', isim: 'İngiliz Sterlini' },
        { kod: 'CHF', isim: 'İsviçre Frangı' },
        { kod: 'JPY', isim: 'Japon Yeni' }
    ]
};

function updateCodePlaceholder() {
    const tip = document.getElementById('tip').value;
    const kodInput = document.getElementById('kod');
    const kodOrnekleri = document.getElementById('kodOrnekleri');
    const validateBtn = document.getElementById('validateBtn');
    
    const ornekler = {
        'fon': {
            placeholder: 'Fon kodu girin (örn: ZBJ, APK, AEF...)',
            ornekler: 'Popüler fonlar: ZBJ, APK, AEF, AFT, AHF - Yazmaya başlayın...'
        },
        'hisse': {
            placeholder: 'Hisse kodu girin (örn: THYAO, GARAN...)',
            ornekler: 'Popüler hisseler: THYAO, GARAN, ASELS, SISE, BIMAS - Yazmaya başlayın...'
        },
        'altin': {
            placeholder: 'Altın türü girin (örn: GA, C, Y...)',
            ornekler: 'Altın türleri: GA (Gram), C (Çeyrek), Y (Yarım), T (Tam), ONS (Ons)'
        },
        'doviz': {
            placeholder: 'Döviz kodu girin (örn: USD, EUR...)',
            ornekler: 'Dövizler: USD, EUR, GBP, CHF, JPY - Yazmaya başlayın...'
        }
    };
    
    if (tip && ornekler[tip]) {
        kodInput.placeholder = ornekler[tip].placeholder;
        kodOrnekleri.innerHTML = `<i class="fas fa-info-circle me-1"></i>${ornekler[tip].ornekler}`;
        kodOrnekleri.style.display = 'block';
        validateBtn.style.display = 'block';
        kodInput.disabled = false;
    } else {
        kodInput.placeholder = 'Önce yatırım tipi seçin...';
        kodOrnekleri.style.display = 'none';
        validateBtn.style.display = 'none';
        kodInput.disabled = true;
    }
    
    // Clear previous results
    document.getElementById('kodSonuc').style.display = 'none';
    document.getElementById('searchResults').style.display = 'none';
    kodInput.value = '';
    document.getElementById('alis_fiyati').value = '';
}

function searchCodes(query) {
    const tip = document.getElementById('tip').value;
    const searchResults = document.getElementById('searchResults');
    
    if (!tip || query.length < 1) {
        searchResults.style.display = 'none';
        return;
    }
    
    const codes = investmentCodes[tip] || [];
    const filteredCodes = codes.filter(item => 
        item.kod.toLowerCase().includes(query.toLowerCase()) ||
        item.isim.toLowerCase().includes(query.toLowerCase())
    );
    
    if (filteredCodes.length > 0) {
        searchResults.innerHTML = filteredCodes.map(item => `
            <a href="#" class="list-group-item list-group-item-action" onclick="selectCode('${item.kod}', '${item.isim}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${item.kod}</h6>
                    <small>${tip.toUpperCase()}</small>
                </div>
                <p class="mb-1">${item.isim}</p>
            </a>
        `).join('');
        searchResults.style.display = 'block';
    } else {
        searchResults.style.display = 'none';
    }
}

function selectCode(kod, isim) {
    document.getElementById('kod').value = kod;
    document.getElementById('searchResults').style.display = 'none';
    validateCode();
}

function validateCode() {
    const tip = document.getElementById('tip').value;
    const kod = document.getElementById('kod').value.toUpperCase();
    const kodSonuc = document.getElementById('kodSonuc');
    
    if (!tip || !kod) {
        kodSonuc.style.display = 'none';
        return;
    }
    
    // Update the input to uppercase
    document.getElementById('kod').value = kod;
    
    // Check if code exists in predefined list first
    const codes = investmentCodes[tip] || [];
    const foundCode = codes.find(item => item.kod === kod);
    
    if (!foundCode) {
        kodSonuc.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Dikkat:</strong> "${kod}" kodu ${tip} listesinde bulunamadı. 
                Devam etmek istiyorsanız manuel olarak fiyat girmeniz gerekebilir.
            </div>
        `;
        kodSonuc.style.display = 'block';
        return;
    }
    
    // Show loading
    kodSonuc.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            ${foundCode.isim} için güncel fiyat kontrol ediliyor...
        </div>
    `;
    kodSonuc.style.display = 'block';
    
    // Make AJAX request to validate and get current price
    fetch('/api/yatirim_dogrula', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tip: tip,
            kod: kod
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            kodSonuc.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>${data.isim}</strong><br>
                    <small class="text-muted">Güncel Fiyat:</small> <strong>₺${data.guncel_fiyat.toFixed(6)}</strong>
                </div>
            `;
            document.getElementById('alis_fiyati').value = data.guncel_fiyat.toFixed(6);
        } else {
            kodSonuc.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>${foundCode.isim}</strong><br>
                    Güncel fiyat alınamadı: ${data.error}<br>
                    <small class="text-muted">Manuel fiyat girmeniz gerekebilir.</small>
                </div>
            `;
        }
        kodSonuc.style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        kodSonuc.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle me-2"></i>
                Kod doğrulama sırasında hata oluştu. Lütfen tekrar deneyin.
            </div>
        `;
        kodSonuc.style.display = 'block';
    });
}

// Hide search results when clicking outside
document.addEventListener('click', function(event) {
    const searchResults = document.getElementById('searchResults');
    const kodInput = document.getElementById('kod');
    
    if (!searchResults.contains(event.target) && event.target !== kodInput) {
        searchResults.style.display = 'none';
    }
});

// Set today's date as default
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('alis_tarihi').value = today;
});
</script>
{% endblock %}
