{% extends "base.html" %}

{% block title %}Yatırımlar - Yatırım Takip{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>
                    <i class="fas fa-chart-line me-2"></i>
                    Yatırımlarım
                </h1>
                <div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#yatirimEkleModal">
                        <i class="fas fa-plus me-2"></i>Yeni Yatırım
                    </button>
                    <form method="POST" action="{{ url_for('toplu_fiyat_guncelle') }}" class="d-inline">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-sync me-2"></i>Fiyatları Güncelle
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Arama</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search }}" placeholder="Kod, isim veya nota göre ara...">
                        </div>
                        <div class="col-md-3">
                            <label for="tip" class="form-label">Tip</label>
                            <select class="form-select" id="tip" name="tip">
                                <option value="">Tümü</option>
                                <option value="fon" {% if tip_filter == 'fon' %}selected{% endif %}>Fon</option>
                                <option value="hisse" {% if tip_filter == 'hisse' %}selected{% endif %}>Hisse</option>
                                <option value="altin" {% if tip_filter == 'altin' %}selected{% endif %}>Altın</option>
                                <option value="doviz" {% if tip_filter == 'doviz' %}selected{% endif %}>Döviz</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="kategori" class="form-label">Kategori</label>
                            <select class="form-select" id="kategori" name="kategori">
                                <option value="">Tümü</option>
                                {% for kategori in kategoriler %}
                                <option value="{{ kategori }}" {% if kategori_filter == kategori %}selected{% endif %}>
                                    {{ kategori }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Filtrele
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Investments Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    {% if yatirimlar %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tip</th>
                                    <th>Kod</th>
                                    <th>İsim</th>
                                    <th>Alış Tarihi</th>
                                    <th>Alış Fiyatı</th>
                                    <th>Miktar</th>
                                    <th>Alış Tutarı</th>
                                    <th>Güncel Fiyat</th>
                                    <th>Satış Fiyatı</th>
                                    <th>Güncel Tutar</th>
                                    <th>Kar/Zarar</th>
                                    <th>Getiri %</th>
                                    <th>Kategori</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for yatirim in yatirimlar %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">{{ yatirim.tip|title }}</span>
                                    </td>
                                    <td><strong>{{ yatirim.kod }}</strong></td>
                                    <td>
                                        <span class="text-truncate" data-bs-toggle="tooltip" title="{{ yatirim.isim or 'İsim yok' }}">
                                            {{ yatirim.isim[:30] + '...' if yatirim.isim and yatirim.isim|length > 30 else yatirim.isim or '-' }}
                                        </span>
                                    </td>
                                    <td>{{ yatirim.alis_tarihi.strftime('%d.%m.%Y') }}</td>
                                    <td>₺{{ "{:,.2f}".format(yatirim.alis_fiyati) }}</td>
                                    <td>{{ "{:,.2f}".format(yatirim.miktar) }}</td>
                                    <td>₺{{ "{:,.2f}".format(yatirim.alis_fiyati * yatirim.miktar) }}</td>
                                    <td>
                                        {% if yatirim.guncel_fiyat %}
                                            ₺{{ "{:,.2f}".format(yatirim.guncel_fiyat) }}
                                            {% if yatirim.son_guncelleme %}
                                                <br><small class="text-muted">{{ yatirim.son_guncelleme.strftime('%d.%m %H:%M') }}</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if yatirim.guncel_fiyat %}
                                            ₺{{ "{:,.2f}".format(yatirim.guncel_fiyat * yatirim.miktar) }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if yatirim.guncel_fiyat %}
                                            {% set kar_zarar = (yatirim.guncel_fiyat - yatirim.alis_fiyati) * yatirim.miktar %}
                                            <span class="{% if kar_zarar >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                ₺{{ "{:+,.2f}".format(kar_zarar) }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if yatirim.guncel_fiyat %}
                                            {% set getiri = (yatirim.guncel_fiyat / yatirim.alis_fiyati - 1) * 100 %}
                                            <span class="{% if getiri >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ "{:+.2f}".format(getiri) }}%
                                            </span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if yatirim.kategori %}
                                            <span class="badge bg-info">{{ yatirim.kategori }}</span>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <form method="POST" action="{{ url_for('fiyat_guncelle_route', yatirim_id=yatirim.id) }}" class="d-inline">
                                                <button type="submit" class="btn btn-outline-success" data-bs-toggle="tooltip" title="Fiyat Güncelle">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </form>
                                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" 
                                                    data-bs-target="#duzenleModal{{ yatirim.id }}" title="Düzenle">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" 
                                                    data-bs-target="#silModal{{ yatirim.id }}" title="Sil">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted">Henüz yatırım eklenmemiş</h4>
                        <p class="text-muted mb-4">İlk yatırımınızı ekleyerek başlayın!</p>
                        <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#yatirimEkleModal">
                            <i class="fas fa-plus me-2"></i>İlk Yatırımı Ekle
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Investment Modal -->
<div class="modal fade" id="yatirimEkleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Yeni Yatırım Ekle
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('yatirim_ekle') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tip" class="form-label">Yatırım Tipi *</label>
                            <div class="input-group">
                                <select class="form-select" id="tip" name="tip" required onchange="manualTypeChange(this.value)">
                                    <option value="">Seçiniz</option>
                                    <option value="fon">Yatırım Fonu</option>
                                    <option value="hisse">Hisse Senedi</option>
                                    <option value="altin">Altın</option>
                                    <option value="doviz">Döviz</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" onclick="forceActivateCodeInput()" title="Kod girişini etkinleştir">
                                    <i class="fas fa-unlock"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">Eğer kod girişi etkinleşmezse sağdaki butona tıklayın</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="kod" class="form-label">Kod *</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="kod" name="kod" required
                                       placeholder="Önce yatırım tipi seçin..." 
                                       autocomplete="off" disabled>
                                <button type="button" class="btn btn-outline-secondary" id="validateBtn" 
                                        onclick="validateCode()" style="display: none;">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="kodOrnekleri" class="form-text" style="display: none;"></div>
                            <div id="searchResults" class="list-group position-absolute" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto; width: 100%;"></div>
                            <div id="kodSonuc" class="mt-2" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="alis_tarihi" class="form-label">Alış Tarihi *</label>
                            <input type="date" class="form-control" id="alis_tarihi" name="alis_tarihi" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="alis_fiyati" class="form-label">Alış Fiyatı (₺) *</label>
                            <input type="number" class="form-control" id="alis_fiyati" name="alis_fiyati" 
                                   step="0.000001" min="0" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="miktar" class="form-label">Miktar *</label>
                            <input type="number" class="form-control" id="miktar" name="miktar" 
                                   step="0.000001" min="0.000001" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="kategori" class="form-label">Kategori</label>
                            <select class="form-select" id="kategori" name="kategori">
                                <option value="">Kategori Seçin</option>
                                <option value="Emeklilik">Emeklilik</option>
                                <option value="Acil Durum">Acil Durum</option>
                                <option value="Uzun Vadeli">Uzun Vadeli</option>
                                <option value="Kısa Vadeli">Kısa Vadeli</option>
                                <option value="Spekülatif">Spekülatif</option>
                                <option value="Güvenli Liman">Güvenli Liman</option>
                                <option value="Diğer">Diğer</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notlar" class="form-label">Notlar</label>
                        <textarea class="form-control" id="notlar" name="notlar" rows="3"
                                  placeholder="İsteğe bağlı notlarınız..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Modals -->
{% for yatirim in yatirimlar %}
<div class="modal fade" id="duzenleModal{{ yatirim.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Yatırım Düzenle: {{ yatirim.kod }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('yatirim_duzenle', yatirim_id=yatirim.id) }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Alış Fiyatı (₺)</label>
                        <input type="number" class="form-control" name="alis_fiyati" 
                               step="0.000001" value="{{ yatirim.alis_fiyati }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Miktar</label>
                        <input type="number" class="form-control" name="miktar" 
                               step="0.000001" value="{{ yatirim.miktar }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kategori</label>
                        <input type="text" class="form-control" name="kategori" value="{{ yatirim.kategori or '' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notlar</label>
                        <textarea class="form-control" name="notlar" rows="3">{{ yatirim.notlar or '' }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Güncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="silModal{{ yatirim.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>Yatırım Sil
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>{{ yatirim.kod }}</strong> kodlu yatırımı silmek istediğinizden emin misiniz?</p>
                <p class="text-muted small">Bu işlem geri alınamaz ve tüm fiyat geçmişi de silinecektir.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <form method="POST" action="{{ url_for('yatirim_sil', yatirim_id=yatirim.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Sil
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default date to today
    document.getElementById('alis_tarihi').value = new Date().toISOString().split('T')[0];
    
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Predefined investment codes for search
const investmentCodes = {
    'fon': [
        { kod: 'TLI', isim: 'TÜRK LİRASI PARA PİYASASI FONU' },
        { kod: 'TI2', isim: 'TEB PORTFÖY İKİNCİ FONU' },
        { kod: 'AFA', isim: 'AKBANK PORTFÖY FLEKSİBEL FON A' },
        { kod: 'TTE', isim: 'TEB PORTFÖY EURO FON' },
        { kod: 'ZBJ', isim: 'ZİRAAT PORTFÖY BAŞAK PARA PİYASASI (TL) FONU' },
        { kod: 'APK', isim: 'AKBANK PORTFÖY HİSSE SENEDİ FONU' },
        { kod: 'AEF', isim: 'AKBANK PORTFÖY EUROBOND (TL) FONU' },
        { kod: 'AFT', isim: 'AKBANK PORTFÖY FLEKSİBEL FON SERİSİ 2' }
    ],
    'hisse': [
        { kod: 'THY', isim: 'TÜRK HAVA YOLLARI A.O.' },
        { kod: 'ZB', isim: 'ZİRAAT BANKASI A.Ş.' },
        { kod: 'GA', isim: 'GARANTİ BANKASI A.Ş.' },
        { kod: 'THYAO', isim: 'TÜRK HAVA YOLLARI A.O.' },
        { kod: 'GARAN', isim: 'GARANTİ BANKASI A.Ş.' },
        { kod: 'ASELS', isim: 'ASELSAN ELEKTRONİK SANAYİ VE TİCARET A.Ş.' },
        { kod: 'SISE', isim: 'ŞİŞE VE CAM FABRİKALARI A.Ş.' },
        { kod: 'BIMAS', isim: 'BİM BİRLEŞİK MAĞAZALAR A.Ş.' }
    ],
    'altin': [
        { kod: 'GA', isim: 'Gram Altın' },
        { kod: 'C', isim: 'Çeyrek Altın' },
        { kod: 'Y', isim: 'Yarım Altın' },
        { kod: 'T', isim: 'Tam Altın' },
        { kod: 'ONS', isim: 'Ons Altın' }
    ],
    'doviz': [
        { kod: 'USD', isim: 'Amerikan Doları' },
        { kod: 'EUR', isim: 'Euro' },
        { kod: 'GBP', isim: 'İngiliz Sterlini' },
        { kod: 'CHF', isim: 'İsviçre Frangı' },
        { kod: 'JPY', isim: 'Japon Yeni' }
    ]
};

function handleInvestmentTypeChange() {
    console.log('=== handleInvestmentTypeChange called ===');
    const tipSelect = document.getElementById('tip');
    const kodInput = document.getElementById('kod');
    const kodOrnekleri = document.getElementById('kodOrnekleri');
    const validateBtn = document.getElementById('validateBtn');
    
    console.log('Elements found:', {
        tipSelect: !!tipSelect,
        kodInput: !!kodInput,
        kodOrnekleri: !!kodOrnekleri,
        validateBtn: !!validateBtn
    });
    
    if (!tipSelect || !kodInput) {
        console.log('Missing essential elements, returning');
        return;
    }
    
    const tip = tipSelect.value;
    console.log('Selected investment type:', tip);
    
    const ornekler = {
        'fon': {
            placeholder: 'Fon kodu girin (örn: TLI, TI2, AFA, TTE...)',
            ornekler: 'Örnek: TLI, TI2, AFA, TTE - Yazmaya başlayın...'
        },
        'hisse': {
            placeholder: 'Hisse kodu girin (örn: THY, ZB, GA...)',
            ornekler: 'Örnek: THY, ZB, GA - Yazmaya başlayın...'
        },
        'altin': {
            placeholder: 'Altın türü girin (GA, C, Y, T, ONS)',
            ornekler: 'GA (Gram Altın), C (Çeyrek), Y (Yarım), T (Tam), ONS'
        },
        'doviz': {
            placeholder: 'Döviz kodu girin (USD, EUR, GBP...)',
            ornekler: 'Örnek: USD, EUR, GBP, CHF, JPY - Yazmaya başlayın...'
        }
    };
    
    if (tip && ornekler[tip]) {
        console.log('ENABLING code input for type:', tip);
        
        // Enable and configure the code input
        console.log('Before enable - disabled status:', kodInput.disabled);
        kodInput.disabled = false;
        kodInput.removeAttribute('disabled');
        console.log('After enable - disabled status:', kodInput.disabled);
        
        kodInput.placeholder = ornekler[tip].placeholder;
        console.log('Set placeholder to:', ornekler[tip].placeholder);
        
        // Show examples
        if (kodOrnekleri) {
            kodOrnekleri.innerHTML = `<i class="fas fa-info-circle me-1"></i>${ornekler[tip].ornekler}`;
            kodOrnekleri.style.display = 'block';
            console.log('Examples shown');
        }
        
        // Show validate button
        if (validateBtn) {
            validateBtn.style.display = 'block';
            console.log('Validate button shown');
        }
        
        console.log('Code input should now be ENABLED');
    } else {
        console.log('DISABLING code input - tip is empty or invalid');
        
        // Disable the code input
        console.log('Before disable - disabled status:', kodInput.disabled);
        kodInput.disabled = true;
        kodInput.setAttribute('disabled', 'disabled');
        console.log('After disable - disabled status:', kodInput.disabled);
        
        kodInput.placeholder = 'Önce yatırım tipi seçin...';
        console.log('Set placeholder to: Önce yatırım tipi seçin...');
        
        // Hide examples
        if (kodOrnekleri) {
            kodOrnekleri.style.display = 'none';
            console.log('Examples hidden');
        }
        
        // Hide validate button
        if (validateBtn) {
            validateBtn.style.display = 'none';
            console.log('Validate button hidden');
        }
        
        console.log('Code input should now be DISABLED');
    }
    
    // Clear previous values and results
    kodInput.value = '';
    const kodSonuc = document.getElementById('kodSonuc');
    const searchResults = document.getElementById('searchResults');
    const alisFiyati = document.getElementById('alis_fiyati');
    
    if (kodSonuc) kodSonuc.style.display = 'none';
    if (searchResults) searchResults.style.display = 'none';
    if (alisFiyati) alisFiyati.value = '';
}

// Backward compatibility
function updateCodePlaceholder() {
    handleInvestmentTypeChange();
}

// Global functions for inline handlers
function manualTypeChange(selectedValue) {
    console.log('>>> MANUAL ONCHANGE CALLED with value:', selectedValue);
    updateFormBasedOnType(selectedValue);
}

function forceActivateCodeInput() {
    console.log('>>> FORCE ACTIVATION BUTTON CLICKED');
    const tipSelect = document.getElementById('tip');
    const currentType = tipSelect ? tipSelect.value : '';
    
    if (!currentType || currentType === '') {
        alert('Lütfen önce bir yatırım tipi seçin!');
        return;
    }
    
    console.log('Forcing activation for type:', currentType);
    updateFormBasedOnType(currentType);
    
    // Extra force enable
    const kodInput = document.getElementById('kod');
    if (kodInput) {
        kodInput.disabled = false;
        kodInput.removeAttribute('disabled');
        kodInput.focus();
        console.log('Code input force-enabled and focused');
    }
}

// Simplified form update function
function updateFormBasedOnType(selectedType) {
    console.log('=== UPDATING FORM FOR TYPE:', selectedType, '===');
    
    const kodInput = document.getElementById('kod');
    const kodOrnekleri = document.getElementById('kodOrnekleri');
    const validateBtn = document.getElementById('validateBtn');
    
    if (!kodInput) {
        console.error('Kod input not found!');
        return;
    }
    
    if (!selectedType || selectedType === '') {
        console.log('No type selected, disabling input');
        kodInput.disabled = true;
        kodInput.placeholder = "Önce yatırım tipi seçin...";
        if (kodOrnekleri) kodOrnekleri.style.display = 'none';
        if (validateBtn) validateBtn.style.display = 'none';
        return;
    }
    
    // Enable the input and set appropriate placeholder
    console.log('ENABLING INPUT for type:', selectedType);
    kodInput.disabled = false;
    kodInput.removeAttribute('disabled');
    
    // Clear previous code when type changes
    kodInput.value = '';
    
    // Hide search results and validation results
    const searchResults = document.getElementById('searchResults');
    const kodSonuc = document.getElementById('kodSonuc');
    if (searchResults) searchResults.style.display = 'none';
    if (kodSonuc) kodSonuc.style.display = 'none';
    
    // Set placeholders and examples based on type
    const typeConfig = {
        'fon': {
            placeholder: 'Örn: TI2, AFA, TLI',
            examples: 'Örnekler: TI2 (İş Portföy BIST-30), AFA (Ak Portföy Petkim), TLI (Türkiye İş Portföy Likit)'
        },
        'hisse': {
            placeholder: 'Örn: THYAO, ISCTR, GARAN',
            examples: 'Örnekler: THYAO (Türk Hava Yolları), ISCTR (İş Bankası C), GARAN (Garanti BBVA)'
        },
        'altin': {
            placeholder: 'Örn: GA, C, Y, T',
            examples: 'Örnekler: GA (Gram Altın), C (Çeyrek Altın), Y (Yarım Altın), T (Tam Altın)'
        },
        'doviz': {
            placeholder: 'Örn: USD, EUR, GBP',
            examples: 'Örnekler: USD (Amerikan Doları), EUR (Euro), GBP (İngiliz Sterlini)'
        }
    };
    
    const config = typeConfig[selectedType];
    if (config) {
        kodInput.placeholder = config.placeholder;
        if (kodOrnekleri) {
            kodOrnekleri.textContent = config.examples;
            kodOrnekleri.style.display = 'block';
        }
    }
    
    if (validateBtn) validateBtn.style.display = 'inline-block';
    
    // Re-add event handlers to the now-enabled input
    kodInput.oninput = function() {
        console.log('Code input changed:', this.value);
        searchCodes(this.value);
    };
    kodInput.onblur = function() {
        console.log('Code input lost focus, validating...');
        validateCode();
    };
    
    // Also add keyup event for better responsiveness
    kodInput.onkeyup = function() {
        searchCodes(this.value);
    };
    
    console.log('Form updated successfully. Input enabled:', !kodInput.disabled);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('alis_tarihi');
    if (dateInput && !dateInput.value) {
        dateInput.value = today;
    }
    
    // Function to initialize modal form
    function initializeModalForm() {
        console.log('=== INITIALIZING MODAL FORM ===');
        
        const tipSelect = document.getElementById('tip');
        const kodInput = document.getElementById('kod');
        
        if (!tipSelect || !kodInput) {
            console.error('Required elements not found:', {tipSelect: !!tipSelect, kodInput: !!kodInput});
            return;
        }
        
        // Initialize code input as disabled
        kodInput.disabled = true;
        kodInput.placeholder = "Önce yatırım tipi seçin...";
        
        console.log('Setting up DIRECT event handling...');
        
        // Method 1: Direct onchange override
        tipSelect.onchange = function() {
            console.log('>>> DIRECT ONCHANGE FIRED! New value:', this.value);
            updateFormBasedOnType(this.value);
        };
        
        // Method 2: addEventListener as backup
        tipSelect.addEventListener('change', function() {
            console.log('>>> ADDEVENTLISTENER CHANGE FIRED! New value:', this.value);
            updateFormBasedOnType(this.value);
        });
        
        // Method 3: Simple polling as final backup
        let lastKnownValue = tipSelect.value;
        const checkInterval = setInterval(function() {
            if (tipSelect.value !== lastKnownValue) {
                console.log('>>> POLLING DETECTED CHANGE from', lastKnownValue, 'to', tipSelect.value);
                lastKnownValue = tipSelect.value;
                updateFormBasedOnType(tipSelect.value);
            }
        }, 300);
        
        // Cleanup on modal close
        const modal = document.getElementById('yatirimEkleModal');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function() {
                clearInterval(checkInterval);
            });
        }
        
        console.log('Event handlers set up. Initial state update...');
        updateFormBasedOnType(tipSelect.value);
    }
    
    // Simplified form update function
    function updateFormBasedOnType(selectedType) {
        console.log('=== UPDATING FORM FOR TYPE:', selectedType, '===');
        
        const kodInput = document.getElementById('kod');
        const kodOrnekleri = document.getElementById('kodOrnekleri');
        const validateBtn = document.getElementById('validateBtn');
        
        if (!kodInput) {
            console.error('Kod input not found!');
            return;
        }
        
        if (!selectedType || selectedType === '') {
            console.log('No type selected, disabling input');
            kodInput.disabled = true;
            kodInput.placeholder = "Önce yatırım tipi seçin...";
            if (kodOrnekleri) kodOrnekleri.style.display = 'none';
            if (validateBtn) validateBtn.style.display = 'none';
            return;
        }
        
        // Enable the input and set appropriate placeholder
        console.log('ENABLING INPUT for type:', selectedType);
        kodInput.disabled = false;
        kodInput.removeAttribute('disabled');
        
        // Set placeholders and examples based on type
        const typeConfig = {
            'fon': {
                placeholder: 'Örn: TI2, AFA, TLI',
                examples: 'Örnekler: TI2 (İş Portföy BIST-30), AFA (Ak Portföy Petkim), TLI (Türkiye İş Portföy Likit)'
            },
            'hisse': {
                placeholder: 'Örn: THYAO, ISCTR, GARAN',
                examples: 'Örnekler: THYAO (Türk Hava Yolları), ISCTR (İş Bankası C), GARAN (Garanti BBVA)'
            },
            'altin': {
                placeholder: 'Örn: GA, C, Y, T',
                examples: 'Örnekler: GA (Gram Altın), C (Çeyrek Altın), Y (Yarım Altın), T (Tam Altın)'
            },
            'doviz': {
                placeholder: 'Örn: USD, EUR, GBP',
                examples: 'Örnekler: USD (Amerikan Doları), EUR (Euro), GBP (İngiliz Sterlini)'
            }
        };
        
        const config = typeConfig[selectedType];
        if (config) {
            kodInput.placeholder = config.placeholder;
            if (kodOrnekleri) {
                kodOrnekleri.textContent = config.examples;
                kodOrnekleri.style.display = 'block';
            }
        }
        
        if (validateBtn) validateBtn.style.display = 'inline-block';
        
        // Re-add event handlers to the now-enabled input
        kodInput.oninput = function() {
            searchCodes(this.value);
        };
        kodInput.onblur = function() {
            validateCode();
        };
        
        console.log('Form updated successfully. Input enabled:', !kodInput.disabled);
    }
    
    // Initialize on page load
    initializeModalForm();
    
    // Re-initialize when modal is shown
    const modal = document.getElementById('yatirimEkleModal');
    if (modal) {
        modal.addEventListener('shown.bs.modal', function() {
            console.log('Modal shown, re-initializing form...');
            setTimeout(initializeModalForm, 100); // Small delay to ensure DOM is ready
        });
    }
});

function searchCodes(query) {
    console.log('=== SEARCH CODES CALLED ===');
    // Get the tip from the modal specifically, not the page search form
    const modalTipSelect = document.querySelector('#yatirimEkleModal #tip');
    const tip = modalTipSelect ? modalTipSelect.value : '';
    const searchResults = document.getElementById('searchResults');
    
    console.log('Search query:', query, 'Type:', tip);
    console.log('SearchResults element:', !!searchResults);
    
    if (!tip || query.length < 1) {
        console.log('No type or query too short, hiding results');
        if (searchResults) searchResults.style.display = 'none';
        return;
    }
    
    const codes = investmentCodes[tip] || [];
    console.log('Available codes for type', tip, ':', codes.length, codes);
    
    const filteredCodes = codes.filter(item => 
        item.kod.toLowerCase().includes(query.toLowerCase()) ||
        item.isim.toLowerCase().includes(query.toLowerCase())
    );
    
    console.log('Filtered codes:', filteredCodes.length, filteredCodes);
    
    if (filteredCodes.length > 0) {
        const html = filteredCodes.map(item => `
            <a href="#" class="list-group-item list-group-item-action" onclick="selectCode('${item.kod}', '${item.isim}')">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${item.kod}</h6>
                    <small>${tip.toUpperCase()}</small>
                </div>
                <p class="mb-1">${item.isim}</p>
            </a>
        `).join('');
        
        console.log('Setting HTML and showing results');
        searchResults.innerHTML = html;
        searchResults.style.display = 'block';
    } else {
        console.log('No matches found, hiding results');
        searchResults.style.display = 'none';
    }
}

function selectCode(kod, isim) {
    document.getElementById('kod').value = kod;
    document.getElementById('searchResults').style.display = 'none';
    validateCode();
}

function validateCode() {
    // Get the tip from the modal specifically, not the page search form
    const modalTipSelect = document.querySelector('#yatirimEkleModal #tip');
    const tip = modalTipSelect ? modalTipSelect.value : '';
    const kod = document.getElementById('kod').value.toUpperCase();
    const kodSonuc = document.getElementById('kodSonuc');
    
    if (!tip || !kod) {
        kodSonuc.style.display = 'none';
        return;
    }
    
    // Update the input to uppercase
    document.getElementById('kod').value = kod;
    
    // Check if code exists in predefined list first
    const codes = investmentCodes[tip] || [];
    const foundCode = codes.find(item => item.kod === kod);
    
    if (!foundCode) {
        kodSonuc.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Dikkat:</strong> "${kod}" kodu ${tip} listesinde bulunamadı. 
                Devam etmek istiyorsanız manuel olarak fiyat girmeniz gerekebilir.
            </div>
        `;
        kodSonuc.style.display = 'block';
        return;
    }
    
    // Show loading
    kodSonuc.innerHTML = `
        <div class="alert alert-info">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            ${foundCode.isim} için güncel fiyat kontrol ediliyor...
        </div>
    `;
    kodSonuc.style.display = 'block';
    
    // Make AJAX request to validate and get current price
    fetch('/api/yatirim_dogrula', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tip: tip,
            kod: kod
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            kodSonuc.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>${data.isim}</strong><br>
                    <small class="text-muted">Güncel Fiyat:</small> <strong>₺${data.guncel_fiyat.toFixed(6)}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alis_fiyati').value = data.guncel_fiyat.toFixed(6);
            
            // Auto-hide success alert after 5 seconds
            setTimeout(() => {
                const alert = kodSonuc.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => kodSonuc.style.display = 'none', 300);
                }
            }, 5000);
        } else {
            kodSonuc.innerHTML = `
                <div class="alert alert-warning alert-dismissible fade show">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>${foundCode.isim}</strong><br>
                    Güncel fiyat alınamadı: ${data.error}<br>
                    <small class="text-muted">Manuel fiyat girmeniz gerekebilir.</small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        kodSonuc.style.display = 'block';
    })
    .catch(error => {
        console.error('Error:', error);
        kodSonuc.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle me-2"></i>
                Kod doğrulama sırasında hata oluştu. Lütfen tekrar deneyin.
            </div>
        `;
        kodSonuc.style.display = 'block';
    });
}

// Hide search results when clicking outside
document.addEventListener('click', function(event) {
    const searchResults = document.getElementById('searchResults');
    const kodInput = document.getElementById('kod');
    
    if (!searchResults.contains(event.target) && event.target !== kodInput) {
        searchResults.style.display = 'none';
    }
});


</script>
{% endblock %}
